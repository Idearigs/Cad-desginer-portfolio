// Admin Dashboard JavaScript

class AdminDashboard {
    constructor() {
        this.currentUser = null;
        this.currentTab = 'news';
        this.articles = [];
        this.events = [];
        this.galleryImages = [];
        
        this.init();
    }

    init() {
        this.checkAuthStatus();
        this.bindEvents();
        this.loadData();
        
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    async checkAuthStatus() {
        // First check local storage for quick UI decision
        const token = localStorage.getItem('adminToken');
        
        if (!token) {
            this.showLogin();
            return;
        }
        
        try {
            // Verify session with backend (could create a session-check endpoint)
            // For now, we'll just check if we can load protected content
            const response = await fetch('/jewellery-designer/cad-art/api/news/index.php', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                // Session is valid
                this.showDashboard();
            } else {
                // Session expired or invalid
                localStorage.removeItem('adminToken');
                this.showLogin();
            }
        } catch (error) {
            console.error('Auth check error:', error);
            this.showLogin();
        }
    }

    validateToken(token) {
        // Implement proper token validation here
        // For demo purposes, just check if token exists
        return token && token.length > 0;
    }

    showLogin() {
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('adminDashboard').style.display = 'none';
    }

    showDashboard() {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        this.loadData(); // Load data for the current tab
    }

    bindEvents() {
        // Login form
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            this.handleLogout();
        });

        // Tab navigation
        document.querySelectorAll('.tab-trigger').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                this.switchTab(tabName);
            });
        });

        // News Management
        document.getElementById('addNewsBtn').addEventListener('click', () => {
            this.showNewsForm();
        });
        
        document.getElementById('closeNewsForm').addEventListener('click', () => {
            this.hideNewsForm();
        });
        
        document.getElementById('cancelArticle').addEventListener('click', () => {
            this.hideNewsForm();
        });
        
        document.getElementById('articleForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleArticleSubmit();
        });

        // Event Management
        document.getElementById('addEventBtn').addEventListener('click', () => {
            this.showEventForm();
        });
        
        document.getElementById('closeEventForm').addEventListener('click', () => {
            this.hideEventForm();
        });
        
        document.getElementById('cancelEvent').addEventListener('click', () => {
            this.hideEventForm();
        });
        
        document.getElementById('eventFormElement').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleEventSubmit();
        });

        // Gallery Management
        document.getElementById('addGalleryBtn').addEventListener('click', () => {
            this.showGalleryForm();
        });
        
        document.getElementById('closeGalleryForm').addEventListener('click', () => {
            this.hideGalleryForm();
        });
        
        document.getElementById('cancelGallery').addEventListener('click', () => {
            this.hideGalleryForm();
        });
        
        document.getElementById('galleryFormElement').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleGallerySubmit();
        });
        
        // Close modals when clicking outside content area
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    if (modal.id === 'newsFormModal') this.hideNewsForm();
                    if (modal.id === 'eventFormModal') this.hideEventForm();
                    if (modal.id === 'galleryFormModal') this.hideGalleryForm();
                }
            });
        });
        
        // Add keyboard support for closing modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const activeModals = document.querySelectorAll('.modal-overlay.active');
                activeModals.forEach(modal => {
                    if (modal.id === 'newsFormModal') this.hideNewsForm();
                    if (modal.id === 'eventFormModal') this.hideEventForm();
                    if (modal.id === 'galleryFormModal') this.hideGalleryForm();
                });
            }
        });

        // End of event bindings
    }

    async handleLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        const submitBtn = document.querySelector('.login-btn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');

        // Show loading state
        btnText.style.display = 'none';
        btnLoading.style.display = 'flex';
        submitBtn.disabled = true;
        errorDiv.style.display = 'none';

        try {
            // Create form data for submission
            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            
            // Send login request to backend
            const response = await fetch('/jewellery-designer/cad-art/api/auth/login.php', {
                method: 'POST',
                body: formData,
                credentials: 'include' // Include cookies for session
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
                // Store basic info in localStorage for UI purposes
                localStorage.setItem('adminToken', 'session-active');
                this.currentUser = data.data;
                this.showDashboard();
                this.showAlert('Login successful!', 'success');
            } else {
                errorDiv.textContent = data.message || 'Invalid username or password';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            console.error('Login error:', error);
            errorDiv.textContent = 'Login failed. Please try again.';
            errorDiv.style.display = 'block';
        } finally {
            // Hide loading state
            btnText.style.display = 'block';
            btnLoading.style.display = 'none';
            submitBtn.disabled = false;
        }
    }

    async handleLogout() {
        try {
            // Call logout API
            const response = await fetch('/jewellery-designer/cad-art/api/auth/logout.php', {
                method: 'POST',
                credentials: 'include' // Include cookies for session
            });
            
            // Clear local storage regardless of API response
            localStorage.removeItem('adminToken');
            this.currentUser = null;
            this.showLogin();
            this.showAlert('Logged out successfully!', 'success');
        } catch (error) {
            console.error('Logout error:', error);
            // Still logout client-side even if API fails
            localStorage.removeItem('adminToken');
            this.currentUser = null;
            this.showLogin();
        }
    }

    switchTab(tabName) {
        // Update tab triggers
        document.querySelectorAll('.tab-trigger').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}Tab`).classList.add('active');

        this.currentTab = tabName;
        this.loadTabContent(tabName);
    }

    loadTabContent(tabName) {
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Show selected tab content
        document.getElementById(`${tabName}Tab`).style.display = 'block';
        
        // Update active tab trigger
        document.querySelectorAll('.tab-trigger').forEach(tab => {
            if (tab.dataset.tab === tabName) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // Load tab-specific data
        switch(tabName) {
            case 'news':
                this.loadArticles();
                break;
            case 'events':
                this.loadEvents();
                break;
            case 'gallery':
                this.loadGallery();
                break;
        }
        
        // Store current tab
        this.currentTab = tabName;
    }

    async loadData() {
        // Initialize data structures
        this.articles = [];
        this.events = [];
        this.galleryImages = [];
        this.galleryCategories = [];
        
        // Load data for the current tab only
        // This avoids making unnecessary API calls for tabs that aren't visible
        this.loadTabContent(this.currentTab);
    }

    // News Management
    async loadArticles() {
        try {
            const response = await fetch('/jewellery-designer/cad-art/api/news/index.php', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load articles');
            }
            
            const result = await response.json();
            this.articles = result.data || [];
            this.renderArticles();
        } catch (error) {
            console.error('Error loading articles:', error);
            this.showAlert('Failed to load articles', 'error');
        }
    }

    showNewsForm(article = null) {
        const modal = document.getElementById('newsFormModal');
        const title = document.getElementById('newsFormTitle');
        
        if (article) {
            title.textContent = 'Edit Article';
            this.populateArticleForm(article);
        } else {
            title.textContent = 'Add New Article';
            document.getElementById('articleForm').reset();
        }
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    }

    hideNewsForm() {
        const modal = document.getElementById('newsFormModal');
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Re-enable scrolling
    }

    populateArticleForm(article) {
        document.getElementById('articleTitle').value = article.title;
        document.getElementById('articleAuthor').value = article.author || '';
        document.getElementById('articlePublication').value = article.publication || '';
        document.getElementById('articleDate').value = article.date || '';
        document.getElementById('articleContent').value = article.content || '';
        
        // If there are tags, add them
        if (article.tags && article.tags.length > 0) {
            document.getElementById('articleTags').value = article.tags.join(', ');
        }
    }

    async handleArticleSubmit() {
        const form = document.getElementById('articleForm');
        const articleId = form.dataset.articleId;
        
        try {
            // Create FormData object to handle file uploads
            const formData = new FormData(form);
            
            // Parse tags (comma-separated) if the element exists
            const tagsElement = document.getElementById('articleTags');
            if (tagsElement && tagsElement.value) {
                // Remove tags from formData and handle separately in JSON
                const tags = tagsElement.value.split(',').map(tag => tag.trim()).filter(tag => tag);
                formData.delete('tags');
                formData.append('tags', JSON.stringify(tags));
            }
            
            let url = '/jewellery-designer/cad-art/api/news/index.php';
            let method = 'POST';
            
            // If editing, use PUT method and include article ID
            if (articleId) {
                url += `?id=${articleId}`;
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                body: formData,
                credentials: 'include'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to save article');
            }
            
            const result = await response.json();
            
            this.hideNewsForm();
            this.loadArticles(); // Refresh the articles list
            this.showAlert(articleId ? 'Article updated successfully!' : 'Article added successfully!', 'success');
        } catch (error) {
            console.error('Error saving article:', error);
            this.showAlert(error.message || 'Failed to save article', 'error');
        }
    }

    renderArticles() {
        const container = document.getElementById('articlesList');
        
        if (this.articles.length === 0) {
            container.innerHTML = '<div class="empty-state">No articles found. Click "Add Article" to create one.</div>';
            return;
        }
        
        container.innerHTML = this.articles.map(article => {
            // Fix image path by checking if it's a full URL or just a filename
            let imagePath = article.image || article.image_url || 'images/placeholder.jpg';
            if (imagePath && !imagePath.startsWith('http') && !imagePath.startsWith('/')) {
                imagePath = 'uploads/' + imagePath; // Add uploads directory prefix if it's just a filename
            }
            
            return `
            <div class="article-card">
                <div class="article-image">
                    <img src="${imagePath}" alt="${article.title}" onerror="this.src='images/placeholder.jpg'">
                </div>
                <div class="article-content">
                    <h3>${article.title}</h3>
                    <div class="article-meta">
                        ${article.author ? `<span><i data-lucide="user"></i> ${article.author}</span>` : ''}
                        ${article.publication ? `<span><i data-lucide="book-open"></i> ${article.publication}</span>` : ''}
                        ${article.date ? `<span><i data-lucide="calendar"></i> ${article.date}</span>` : ''}
                    </div>
                    <p class="article-excerpt">${article.content ? article.content.substring(0, 100) + '...' : 'No content'}</p>
                    ${article.tags && article.tags.length > 0 ? 
                        `<div class="article-tags">
                            ${article.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>` : ''
                    }
                    <div class="article-date">Added: ${new Date(article.created_at).toLocaleDateString()}</div>
                </div>
                <div class="article-actions">
                    <button class="btn-icon edit-btn" onclick="admin.editArticle(${article.id})">
                        <i data-lucide="pencil"></i>
                    </button>
                    <button class="btn-icon delete-btn" onclick="admin.deleteArticle(${article.id})">
                        <i data-lucide="trash"></i>
                    </button>
                </div>
            </div>
        `}).join('');

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    async editArticle(id) {
        try {
            const response = await fetch(`/jewellery-designer/cad-art/api/news/index.php?id=${id}`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load article details');
            }
            
            const result = await response.json();
            const article = result.data;
            
            if (article) {
                this.showNewsForm(article);
            }
        } catch (error) {
            console.error('Error loading article details:', error);
            this.showAlert('Failed to load article details', 'error');
        }
    }

    async deleteArticle(id) {
        if (confirm('Are you sure you want to delete this article?')) {
            try {
                const response = await fetch(`/jewellery-designer/cad-art/api/news/index.php?id=${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete article');
                }
                
                this.loadArticles(); // Refresh the articles list
                this.showAlert('Article deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting article:', error);
                this.showAlert(error.message || 'Failed to delete article', 'error');
            }
        }
    }

    // Event Management
    showEventForm(event = null) {
        const modal = document.getElementById('eventFormModal');
        const title = document.getElementById('eventFormTitle');
        
        if (event) {
            title.textContent = 'Edit Event';
            this.populateEventForm(event);
        } else {
            title.textContent = 'Add New Event';
            document.getElementById('eventFormElement').reset();
        }
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    }

    hideEventForm() {
        const modal = document.getElementById('eventFormModal');
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Re-enable scrolling
    }

    populateEventForm(event) {
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventOrder').value = event.display_order || 1;
        document.getElementById('eventFormElement').dataset.eventId = event.id;
        // Image can't be populated due to security restrictions
    }

    async handleEventSubmit() {
        const form = document.getElementById('eventFormElement');
        const formData = new FormData(form);
        const eventId = form.dataset.eventId;
        
        // Validate required fields
        if (!formData.get('title')) {
            this.showAlert('Please provide a title for the event banner.', 'error');
            return;
        }
        
        try {
            let url = '/jewellery-designer/cad-art/api/events/index.php';
            let method = 'POST';
            
            // If editing, use PUT method and include event ID
            if (eventId) {
                url += `?id=${eventId}`;
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                body: formData,
                credentials: 'include'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to save event');
            }
            
            this.hideEventForm();
            this.loadEvents(); // Refresh the events list
            this.showAlert(eventId ? 'Event banner updated successfully!' : 'Event banner added successfully!', 'success');
        } catch (error) {
            console.error('Error saving event:', error);
            this.showAlert(error.message || 'Failed to save event banner', 'error');
        }
    }

    async loadEvents() {
        try {
            const response = await fetch('/jewellery-designer/cad-art/api/events/index.php', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load events');
            }
            
            const result = await response.json();
            this.events = result.data || [];
            this.renderEvents();
        } catch (error) {
            console.error('Error loading events:', error);
        }
    }
    
    renderEvents() {
        const container = document.getElementById('eventsList');
        
        if (this.events.length === 0) {
            container.innerHTML = '<div class="empty-state">No events found. Click "Add Event" to create one.</div>';
            return;
        }
        
        container.innerHTML = this.events.map(event => {
            // Fix image path by checking if it's a full URL or just a filename
            let imagePath = event.image || event.image_url || 'images/placeholder.jpg';
            if (imagePath && !imagePath.startsWith('http') && !imagePath.startsWith('/')) {
                imagePath = 'uploads/' + imagePath; // Add uploads directory prefix if it's just a filename
            }
            
            return `
            <div class="event-card" data-id="${event.id}">
                <div class="event-image">
                    <img src="${imagePath}" alt="${event.title}" onerror="this.src='images/placeholder.jpg'">
                </div>
                <div class="event-content">
                    <h3>${event.title}</h3>
                    <div class="event-meta">
                        ${event.date ? `<span><i data-lucide="calendar"></i> ${event.date}</span>` : ''}
                        ${event.time ? `<span><i data-lucide="clock"></i> ${event.time}</span>` : ''}
                        ${event.location ? `<span><i data-lucide="map-pin"></i> ${event.location}</span>` : ''}
                    </div>
                    <p class="event-description">${event.description || 'No description available'}</p>
                </div>
                <div class="event-actions">
                    <button class="btn-icon move-up-btn" onclick="admin.moveEventUp(${event.id})">
                        <i data-lucide="chevron-up"></i>
                    </button>
                    <button class="btn-icon move-down-btn" onclick="admin.moveEventDown(${event.id})">
                        <i data-lucide="chevron-down"></i>
                    </button>
                    <button class="btn-icon edit-btn" onclick="admin.editEvent(${event.id})">
                        <i data-lucide="pencil"></i>
                    </button>
                    <button class="btn-icon delete-btn" onclick="admin.deleteEvent(${event.id})">
                        <i data-lucide="trash"></i>
                    </button>
                </div>
            </div>
            `;
        }).join('');
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    
if (article) {
this.showNewsForm(article);
}
} catch (error) {
console.error('Error loading article details:', error);
this.showAlert('Failed to load article details', 'error');
}
}

async deleteArticle(id) {
if (confirm('Are you sure you want to delete this article?')) {
try {
const response = await fetch(`/jewellery-designer/cad-art/api/news/index.php?id=${id}`, {
method: 'DELETE',
credentials: 'include'
});
        
if (!response.ok) {
const errorData = await response.json();
throw new Error(errorData.message || 'Failed to delete article');
}
        
this.loadArticles(); // Refresh the articles list
this.showAlert('Article deleted successfully!', 'success');
} catch (error) {
console.error('Error deleting article:', error);
this.showAlert(error.message || 'Failed to delete article', 'error');
}
}
}

// Event Management
showEventForm(event = null) {
const modal = document.getElementById('eventFormModal');
const title = document.getElementById('eventFormTitle');
        
if (event) {
title.textContent = 'Edit Event';
this.populateEventForm(event);
} else {
title.textContent = 'Add New Event';
document.getElementById('eventFormElement').reset();
}
        
modal.classList.add('active');
document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
}

    async editEvent(id) {
        try {
            const response = await fetch(`/jewellery-designer/cad-art/api/events/index.php?id=${id}`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load event details');
            }
            
            const result = await response.json();
            const event = result.data;
            
            if (event) {
                this.showEventForm(event);
            }
        } catch (error) {
            console.error('Error loading event details:', error);
            this.showAlert('Failed to load event details', 'error');
        }
    }

    async deleteEvent(id) {
        if (confirm('Are you sure you want to delete this event banner?')) {
            try {
                const response = await fetch(`/jewellery-designer/cad-art/api/events/index.php?id=${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete event');
                }
                
                this.loadEvents(); // Refresh the events list
                this.showAlert('Event banner deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting event:', error);
                this.showAlert(error.message || 'Failed to delete event banner', 'error');
            }
        }
    }

    async moveEventUp(id) {
        try {
            const index = this.events.findIndex(e => e.id === id);
            if (index <= 0) return; // Already at the top
            
            // Get the current order of events
            const eventIds = this.events.map(e => e.id);
            
            // Swap positions
            [eventIds[index], eventIds[index - 1]] = [eventIds[index - 1], eventIds[index]];
            
            // Send the new order to the API
            const response = await fetch('/jewellery-designer/cad-art/api/events/index.php?action=reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ order: eventIds }),
                credentials: 'include'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update event order');
            }
            
            this.loadEvents(); // Refresh with new order
            this.showAlert('Event banner moved up successfully', 'success');
        } catch (error) {
            console.error('Error reordering events:', error);
            this.showAlert(error.message || 'Failed to update event order', 'error');
        }
    }
    
    async moveEventDown(id) {
        try {
            const index = this.events.findIndex(e => e.id === id);
            if (index === -1 || index >= this.events.length - 1) return; // Already at the bottom
            
            // Get the current order of events
            const eventIds = this.events.map(e => e.id);
            
            // Swap positions
            [eventIds[index], eventIds[index + 1]] = [eventIds[index + 1], eventIds[index]];
            
            // Send the new order to the API
            const response = await fetch('/jewellery-designer/cad-art/api/events/index.php?action=reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ order: eventIds }),
                credentials: 'include'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update event order');
            }
            
            this.loadEvents(); // Refresh with new order
            this.showAlert('Event banner moved down successfully', 'success');
        } catch (error) {
            console.error('Error reordering events:', error);
            this.showAlert(error.message || 'Failed to update event order', 'error');
        }
    }

    // Gallery Management
    showGalleryForm() {
        const modal = document.getElementById('galleryFormModal');
        document.getElementById('galleryFormElement').reset();
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    }

    hideGalleryForm() {
        const modal = document.getElementById('galleryFormModal');
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Re-enable scrolling
    }

    async handleGallerySubmit() {
        const formData = new FormData(document.getElementById('galleryFormElement'));
        const files = formData.get('images').files || [];
        
        if (files.length === 0) {
            this.showAlert('Please select at least one image.', 'error');
            return;
        }

        try {
            const category = formData.get('category');
            if (!category) {
                this.showAlert('Please select a category for the images.', 'error');
                return;
            }
            
            // Create a loading indicator
            this.showAlert(`Uploading ${files.length} image(s)...`, 'info');
            
            // Upload each image individually
            for (const file of files) {
                const singleFormData = new FormData();
                singleFormData.append('image', file);
                singleFormData.append('category', category);
                
                const response = await fetch('/jewellery-designer/cad-art/api/gallery/index.php', {
                    method: 'POST',
                    body: singleFormData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Failed to upload ${file.name}`);
                }
            }
            
            this.loadGallery(); // Refresh the gallery
            this.hideGalleryForm();
            this.showAlert(`${files.length} image(s) uploaded successfully!`, 'success');
        } catch (error) {
            console.error('Error uploading images:', error);
            this.showAlert(error.message || 'Failed to upload images. Please try again.', 'error');
        }
    }

    async loadGallery() {
        try {
            // First, load all available categories
            const categoriesResponse = await fetch('/jewellery-designer/cad-art/api/gallery/index.php?action=categories', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (categoriesResponse.ok) {
                const categoriesResult = await categoriesResponse.json();
                this.galleryCategories = categoriesResult.data || [];
                
                // Update category dropdown in the form
                this.updateCategoryDropdown();
            }
            
            // Then load all gallery images
            const response = await fetch('/jewellery-designer/cad-art/api/gallery/index.php', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load gallery images');
            }
            
            const result = await response.json();
            this.galleryImages = result.data || [];
            this.renderGallery();
        } catch (error) {
            console.error('Error loading gallery:', error);
            this.showAlert('Failed to load gallery images', 'error');
        }
    }

    renderGallery() {
        const container = document.getElementById('galleryList');
        
        if (!this.galleryImages || this.galleryImages.length === 0) {
            container.innerHTML = '<div class="empty-state">No images found. Click "Upload Images" to add some!</div>';
            return;
        }

        // Group images by category
        const imagesByCategory = {};
        this.galleryImages.forEach(image => {
            if (!imagesByCategory[image.category]) {
                imagesByCategory[image.category] = [];
            }
            imagesByCategory[image.category].push(image);
        });

        // Create HTML for each category
        let html = '';
        for (const category in imagesByCategory) {
            html += `
            <div class="gallery-category">
                <h3 class="category-title">${category}</h3>
                <div class="gallery-grid">
                    ${imagesByCategory[category].map(image => `
                    <div class="gallery-item">
                        <div class="gallery-image">
                            <img src="${image.image_url}" alt="${image.filename || 'Gallery image'}">
                        </div>
                        <div class="gallery-actions">
                            <button class="btn-icon" onclick="admin.deleteImage(${image.id})" title="Delete Image">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>`;
        }

        container.innerHTML = html;

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    async deleteImage(id) {
        if (confirm('Are you sure you want to delete this image?')) {
            try {
                const response = await fetch(`/jewellery-designer/cad-art/api/gallery/index.php?id=${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete image');
                }
                
                this.loadGallery(); // Refresh the gallery
                this.showAlert('Image deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting image:', error);
                this.showAlert(error.message || 'Failed to delete image', 'error');
            }
        }
    }

    // Helper method to update category dropdown
    updateCategoryDropdown() {
        const categorySelect = document.getElementById('galleryCategory');
        if (categorySelect) {
            // Clear existing options
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            
            // Add options for each category
            if (this.galleryCategories && this.galleryCategories.length) {
                this.galleryCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        }
    }
    
    // End of Gallery Management

    // Utility Functions
    showAlert(message, type = 'success') {
        const container = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.innerHTML = `
            <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
            <span>${message}</span>
        `;
        
        container.appendChild(alert);
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    // Demo Data
    getDemoArticles() {
        return [
            {
                id: 1,
                title: "Revolutionary CAD Design Wins International Award",
                author: "John Smith",
                publication: "Design Weekly",
                date: "2024-01-15",
                content: "Our latest CAD design project has been recognized with the prestigious International Design Excellence Award. This innovative approach to jewelry design combines traditional craftsmanship with cutting-edge technology...",
                image: "award-winning-design.jpg",
                created_at: "2024-01-15T10:00:00Z"
            },
            {
                id: 2,
                title: "New Sustainable Materials in Jewelry Design",
                author: "Maria Garcia",
                publication: "Eco Design Magazine",
                date: "2024-01-10",
                content: "The jewelry industry is embracing sustainable materials and ethical practices. Our recent collaboration with eco-friendly suppliers has resulted in stunning pieces that don't compromise on beauty or quality...",
                image: "sustainable-jewelry.jpg",
                created_at: "2024-01-10T14:30:00Z"
            }
        ];
    }

    getDemoEvents() {
        return [
            {
                id: 1,
                title: "Annual Jewelry Design Exhibition",
                date: "2024-03-15",
                time: "18:00",
                location: "Grand Exhibition Hall, Downtown",
                description: "Join us for our annual showcase of the year's most innovative jewelry designs. This exclusive event will feature live demonstrations, networking opportunities, and special presentations.",
                image: "exhibition.jpg",
                created_at: "2024-01-01T00:00:00Z"
            },
            {
                id: 2,
                title: "CAD Workshop for Beginners",
                date: "2024-02-28",
                time: "14:00",
                location: "Design Studio, Main Street",
                description: "Learn the fundamentals of computer-aided design for jewelry. This hands-on workshop covers basic CAD principles, software introduction, and practical exercises.",
                image: "workshop.jpg",
                created_at: "2024-01-01T00:00:00Z"
            }
        ];
    }

    getDemoGalleryImages() {
        return [
            { id: 1, filename: "award1.jpg", category: "awards", uploaded_at: "2024-01-01T00:00:00Z" },
            { id: 2, filename: "award2.jpg", category: "awards", uploaded_at: "2024-01-01T00:00:00Z" },
            { id: 3, filename: "project1.jpg", category: "projects", uploaded_at: "2024-01-01T00:00:00Z" },
            { id: 4, filename: "event1.jpg", category: "events", uploaded_at: "2024-01-01T00:00:00Z" }
        ];
    }
}

// Initialize admin dashboard
const admin = new AdminDashboard();